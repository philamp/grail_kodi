name: Build Kodi add-on zip

on:
  push:
    tags:
      - "2026*"

permissions:
  contents: write

jobs:
  zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read addon id and version from addon.xml
        id: meta
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET
          root = ET.parse("addon.xml").getroot()
          addon_id = root.attrib["id"]
          addon_ver = root.attrib["version"]
          print(f"addon_id={addon_id}")
          print(f"addon_ver={addon_ver}")
          PY

          # Write to GITHUB_OUTPUT (the correct way to set step outputs)
          python - <<'PY'
          import xml.etree.ElementTree as ET
          import os
          root = ET.parse("addon.xml").getroot()
          addon_id = root.attrib["id"]
          addon_ver = root.attrib["version"]
          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"addon_id={addon_id}\n")
            f.write(f"addon_ver={addon_ver}\n")
          PY

      - name: Create Kodi-compatible zip (parent folder = addon id)
        run: |
          set -e
          ADDON_ID="${{ steps.meta.outputs.addon_id }}"
          ADDON_VER="${{ steps.meta.outputs.addon_ver }}"
          ZIP_NAME="${ADDON_ID}-${ADDON_VER}.zip"

          mkdir -p "build/${ADDON_ID}"
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".gitignore" \
            --exclude "build" \
            ./ "build/${ADDON_ID}/"

          (cd build && zip -r "../${ZIP_NAME}" "${ADDON_ID}")

          echo "Created ${ZIP_NAME}"
          ls -lh "${ZIP_NAME}"

      - name: Create GitHub Release and upload zip
        uses: softprops/action-gh-release@v2
        with:
          files: "*.zip"
